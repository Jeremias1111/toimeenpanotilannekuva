<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toimeenpanotilannekuva – Hallinnonalat</title>

  <style>
    @font-face{
      font-family:"OwalMark";
      src:
        local("MarkOffcPro"),
        local("MarkOffcPro-Regular"),
        local("MarkOffcPro-ExtraLight"),
        local("MarkOffcPro-Light"),
        local("MarkOffcPro-Medium"),
        local("MarkOffcPro-Bold"),
        local("MarkOffcPro-Black"),
        local("MarkOffcPro-Heavy"),
        local("MarkScOffcPro"),
        local("MarkScOffcPro-Regular"),
        local("MarkScOffcPro-ExtraLight"),
        local("MarkScOffcPro-Light"),
        local("MarkScOffcPro-Medium"),
        local("MarkScOffcPro-Bold"),
        local("MarkScOffcPro-Black"),
        local("MarkScOffcPro-Heavy");
      font-weight:100 900;
      font-style:normal;
      font-display:swap;
    }

    :root{
      --owal-orange:#FF9900;
      --owal-purple:#6600CC;
      --orangeL:#FFF2E8;
      --purpleL:#F2EBFF;

      --text:#141414;
      --muted:#676767;
      --line:#E6E6E6;
      --panel:#F8F8F8;
      --panel2:#F4F4F4;
      --white:#FFFFFF;

      --radius:18px;
      --shadow:0 2px 0 rgba(0,0,0,.02);

      --fw-regular:400;
      --fw-medium:600;
      --fw-bold:700;
      --fw-heavy:900;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"OwalMark",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-weight:var(--fw-regular);
      color:var(--text);
      background:linear-gradient(180deg, #fff 0%, #fff 60%, #fafafa 100%);
    }

    .topbar{
      position:sticky; top:0; z-index:30;
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 22px 12px 22px;
    }
    .topbar::after{
      content:"";
      display:block;
      height:4px;
      background:linear-gradient(90deg, var(--owal-orange), #ffb64a);
      margin:12px -22px -12px -22px;
    }

    .brandRow{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;text-decoration:none;padding:6px 8px;border-radius:14px}
    .logo:hover{background:var(--panel)}
    .logo img{height:34px;width:auto;display:block}
    .titleWrap{flex:1;min-width:280px}
    .productTitle{margin:0;font-size:22px;font-weight:var(--fw-heavy);letter-spacing:-.2px}
    .productSubtitle{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}

    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel2);
      font-size:12px;font-weight:var(--fw-medium);
      text-decoration:none;color:var(--text);
      user-select:none;
    }
    .pill.on{background:var(--orangeL);border-color:rgba(255,153,0,.65)}
    .pill.purple{background:var(--purpleL);border-color:rgba(102,0,204,.35);color:var(--owal-purple)}
    .wrap{max-width:1240px;margin:0 auto;padding:18px 22px 70px 22px}

    .hero{
      margin-top:10px;
      padding:16px 16px;
      border:1px solid var(--line);
      border-radius:22px;
      background:
        radial-gradient(1200px 420px at 15% 0%, var(--orangeL) 0%, rgba(255,242,232,0) 60%),
        radial-gradient(900px 360px at 95% 25%, var(--purpleL) 0%, rgba(242,235,255,0) 60%),
        #fff;
      box-shadow:var(--shadow);
    }
    .heroTitle{margin:0;font-size:28px;font-weight:var(--fw-heavy);letter-spacing:-.35px}
    .heroDesc{margin:8px 0 0 0;color:var(--muted);font-size:13px;line-height:1.4;max-width:900px}

    .card{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-top:14px}
    .cardHeader{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff 0%, #fafafa 100%)}
    .cardBody{padding:14px 16px}
    h2{margin:0;font-size:16px;font-weight:var(--fw-bold)}
    .hint{margin:8px 0 0 0;color:var(--muted);font-size:13px;line-height:1.35}

    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    thead th{font-size:12px;font-weight:var(--fw-bold);background:linear-gradient(180deg,#f0f0f0 0%, #e9e9e9 100%);padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tbody td{font-size:13px;padding:10px;border-bottom:1px solid var(--line);vertical-align:top;line-height:1.35}
    tbody tr:last-child td{border-bottom:none}

    .badge{display:inline-flex;align-items:center;padding:4px 9px;border-radius:12px;font-size:11px;border:1px solid var(--line);background:#EEE;color:var(--muted);font-weight:var(--fw-medium);white-space:nowrap;margin-right:6px;margin-bottom:6px}
    .badge.orange{background:var(--orangeL);border-color:rgba(255,153,0,.6);color:var(--owal-orange)}
    .badge.purple{background:var(--purpleL);border-color:rgba(102,0,204,.35);color:var(--owal-purple)}
    .small{font-size:12px;color:var(--muted)}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}

    details{border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px 12px;margin-top:14px}
    details summary{cursor:pointer;font-size:12px;color:var(--muted);font-weight:var(--fw-medium)}
    details[open]{background:var(--panel)}
    .note{margin-top:10px;color:var(--text);font-size:13px;line-height:1.4}

    .loading{border:1px solid var(--line);border-radius:14px;background:var(--panel);padding:12px;color:var(--muted);font-size:13px}
    .footer{margin-top:22px;padding-top:16px;border-top:1px solid var(--line);color:var(--muted);font-size:12px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brandRow">
      <a class="logo" href="./yleiskuva.html" aria-label="Owal Group">
        <img src="./assets/owal_logo.png" alt="Owal Group logo" />
      </a>
      <div class="titleWrap">
        <div class="productTitle">Toimeenpanotilannekuva</div>
        <div class="productSubtitle">Hallinnonalat: samanaikaisuus ja asetustäsmennykset (abstrakti)</div>
      </div>
    </div>

    <div class="nav">
      <a class="pill" href="./yleiskuva.html">Yleiskuva</a>
      <a class="pill" href="./index.html">Uudistusnäkymä</a>
      <a class="pill on" href="./hallinnonalat.html">Hallinnonalat</a>
      <span class="pill purple">MVP</span>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div class="heroTitle">Hallinnonalojen tilannekuva</div>
      <div class="heroDesc">Koonti säädöspaketeista (laki + asetukset): milloin muutoksia osuu samaan aikaan ja mihin käytännössä (toimeenpanoteemat).</div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>Samanaikaisuus (kvartaali)</h2>
        <div class="hint">Koonti eventtien ajankohdan perusteella. Toimeenpanoteemat ovat kooste teemojen vaikutusalueista.</div>
      </div>
      <div class="cardBody">
        <div id="concurrency" class="loading">Ladataan…</div>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <h2>Täsmennykset asetuksilla</h2>
        <div class="hint">Koonti kaikista säädöspaketeista: mitä asetuksilla täsmennetään.</div>
      </div>
      <div class="cardBody">
        <div id="ref-table" class="loading">Ladataan…</div>
      </div>
    </div>

    <details>
      <summary>Avaa huomiot ja ohjauksen tukitoimet</summary>
      <div class="note" id="notes">—</div>
      <div class="note" id="actions" style="margin-top:10px">—</div>
    </details>

    <div class="footer">
      <div>Owal Group • yhteiskunnallisen vaikuttavuuden asiantuntijayritys • Tieto päätöksenteon tueksi</div>
      <div class="small">Lisää uudet paketit PACKAGES-listaan tiedoston lopussa.</div>
    </div>
  </div>

  <script>
    const PACKAGES = ["pkg-001", "pkg-002"];
    const DATA_DIR = "./data/";
    const $ = (id) => document.getElementById(id);
    const uniq = (arr) => [...new Set((arr||[]).filter(Boolean))];

    function isIsoDate(s){ return typeof s === "string" && /^\\d{4}-\\d{2}-\\d{2}$/.test(s); }
    function quarterLabel(dateStr){
      if(!isIsoDate(dateStr)) return "—";
      const [y,m] = dateStr.split("-").map(n=>parseInt(n,10));
      const q = Math.floor((m-1)/3)+1;
      return `${y} Q${q}`;
    }
    function buildTable(headers, rowsHtml){
      return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rowsHtml}</tbody></table>`;
    }

    async function loadAll(){
      const pkgs = [];
      for(const id of PACKAGES){
        try{
          const res = await fetch(`${DATA_DIR}${id}.json`, {cache:"no-cache"});
          if(!res.ok) continue;
          pkgs.push(await res.json());
        } catch(e){}
      }

      // Samanaikaisuus: kvartaali -> paketit + teemat
      const bucket = {}; // q -> {packages:Set, areas:Map, scopes:Set}
      pkgs.forEach(p=>{
        const qs = uniq((p.events||[]).filter(e=>isIsoDate(e.date)).map(e=>quarterLabel(e.date))).filter(q=>q!=="—");
        qs.forEach(q=>{
          bucket[q] = bucket[q] || {packages:new Set(), areas:new Map(), scopes:new Set()};
          bucket[q].packages.add(p.package_id);
          (p.admin_tags?.kohdistus||[]).forEach(s=>bucket[q].scopes.add(s));
          (p.themes||[]).forEach(t=>{
            const area = t.area || "Muu";
            bucket[q].areas.set(area, (bucket[q].areas.get(area)||0) + 1);
          });
        });
      });

      const qs = Object.keys(bucket).sort();
      const rows = qs.map(q=>{
        const b = bucket[q];
        const topAreas = [...b.areas.entries()].sort((a,b)=>b[1]-a[1]).slice(0,4);
        const areaBadges = topAreas.map(a=>`<span class="badge orange">${a[0]} (${a[1]})</span>`).join("");
        const scopeBadges = [...b.scopes].slice(0,6).map(s=>`<span class="badge">${s}</span>`).join("");
        const packLinks = [...b.packages].map(id=>`<a href="./index.html?id=${id}">${id}</a>`).join(", ");

        return `<tr>
          <td><b>${q}</b></td>
          <td>${b.packages.size}</td>
          <td class="small">${packLinks}</td>
          <td>${scopeBadges || "—"}</td>
          <td>${areaBadges || "—"}</td>
        </tr>`;
      }).join("");

      $("concurrency").className = "";
      $("concurrency").innerHTML = buildTable(
        ["Ajankohta (kvartaali)","Paketteja","Paketit","Kohdistus","Toimeenpanoteemat (top)"],
        rows || `<tr><td colspan="5">Ei ajoitettuja eventtejä tai paketteja liian vähän.</td></tr>`
      );

      // Täsmennykset asetuksilla
      const refs = pkgs.flatMap(p => p.decree_refinements || []);
      const refRows = refs.map(r=>{
        const badgeClass = r.decree==="VNA" ? "orange" : (r.decree==="MIN" ? "purple" : "");
        const scope = (r.scope||[]).join(", ");
        const quote = r.anchor?.quote ? `<div class="small">${r.anchor.quote}</div>` : "";
        return `<tr>
          <td><span class="badge ${badgeClass}">${r.decree}</span></td>
          <td>${r.what || ""}${quote}</td>
          <td>${r.area || ""}</td>
          <td>${scope || ""}</td>
        </tr>`;
      }).join("");

      $("ref-table").className = "";
      $("ref-table").innerHTML = buildTable(
        ["Asetus","Täsmennys","Vaikutusalue","Kohdistus"],
        refRows || `<tr><td colspan="4">Ei täsmennyksiä.</td></tr>`
      );

      // Notes + actions
      const topAreasAll = uniq(pkgs.flatMap(p => (p.themes||[]).map(t=>t.area))).slice(0,4);
      $("notes").innerHTML = `
        • Samanaikaisuutta tarkastellaan kvartaaleittain.<br/>
        • Toimeenpanoteemat korostuvat: ${topAreasAll.length ? topAreasAll.join(", ") : "—"}.
      `;
      $("actions").innerHTML = `
        • Yhtenäistä asetustäsmennykset (minimisisällöt ja termit).<br/>
        • Tee kentälle kooste: mitä täsmennetään asetuksilla ja mihin se kohdistuu.<br/>
        • Kohdista toimeenpanotuki samanaikaisuusjaksoihin (mallipohjat, Q&A, yhteiset linjaukset).
      `;
    }

    loadAll();
  </script>
</body>
</html>
