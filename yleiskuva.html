<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Uudistuskuorman seuranta – Yleiskuva</title>

  <style>
    /* Local font mapping */
    @font-face{
      font-family:"OwalMark";
      src:
        local("MarkOffcPro"), local("MarkOffcPro-Regular"), local("MarkOffcPro-ExtraLight"),
        local("MarkOffcPro-Light"), local("MarkOffcPro-Medium"), local("MarkOffcPro-Bold"),
        local("MarkOffcPro-Black"), local("MarkOffcPro-Heavy"),
        local("MarkScOffcPro"), local("MarkScOffcPro-Regular"), local("MarkScOffcPro-ExtraLight"),
        local("MarkScOffcPro-Light"), local("MarkScOffcPro-Medium"), local("MarkScOffcPro-Bold"),
        local("MarkScOffcPro-Black"), local("MarkScOffcPro-Heavy");
      font-weight:100 900;
      font-style:normal;
      font-display:swap;
    }

    :root{
      /* Brand */
      --orange:#FF9900;
      --orangeRed:#FF6633;
      --orangeTint:#FFF2E8;

      /* Neutrals */
      --text:#141414;
      --muted:#6A6A6A;
      --line:#E7E7E7;
      --bg:#FAFAFA;
      --panel:#F4F4F4;
      --white:#FFFFFF;

      /* Radii */
      --r-lg:18px;
      --r-md:14px;
      --r-sm:12px;

      --shadow:0 1px 0 rgba(0,0,0,.02);

      /* Type system (consistent) */
      --fw-regular:400;
      --fw-medium:600;
      --fw-bold:700;
      --fw-heavy:900;

      --fs-xxl:28px; /* H1 */
      --fs-xl:20px;  /* Page heading */
      --fs-lg:16px;  /* Section title */
      --fs-md:13px;  /* Body */
      --fs-sm:12px;  /* Labels */
      --fs-xs:11px;  /* Micro */
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"OwalMark", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-weight:var(--fw-regular);
      color:var(--text);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 22px 12px 22px;
    }
    .topbar::after{
      content:"";
      display:block;
      height:4px;
      background:linear-gradient(90deg, var(--orange), var(--orangeRed));
      margin:12px -22px -12px -22px;
    }

    .brandRow{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .logo{display:flex;align-items:center;text-decoration:none;padding:6px 8px;border-radius:var(--r-md)}
    .logo:hover{background:var(--panel)}
    .logo img{height:34px;width:auto;display:block}

    .head{min-width:280px;flex:1}
    .pageTitle{
      margin:0;
      font-size:var(--fs-xl);
      font-weight:var(--fw-heavy);
      letter-spacing:-.2px;
      line-height:1.05;
    }
    .pageSub{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:var(--fs-md);
      line-height:1.35;
      font-weight:var(--fw-regular);
    }

    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:var(--fs-sm);
      font-weight:var(--fw-medium);
      text-decoration:none;
      color:var(--text);
      user-select:none;
    }
    .pill.on{
      background:var(--orangeTint);
      border-color:rgba(255,153,0,.55);
    }

    .wrap{max-width:1280px;margin:0 auto;padding:18px 22px 70px 22px}

    /* Filters */
    .filters{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      padding:12px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
    }
    .search{
      flex:1; min-width:240px;
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:var(--bg);
    }
    .searchLabel{
      font-size:var(--fs-sm);
      font-weight:var(--fw-bold);
      color:var(--muted);
    }
    .search input{
      border:none; outline:none; width:100%;
      background:transparent;
      font-family:inherit;
      font-size:var(--fs-md);
      font-weight:var(--fw-regular);
    }
    .select{
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:#fff;
      font-family:inherit;
      font-size:var(--fs-md);
      font-weight:var(--fw-medium);
    }
    .seg{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .segBtn{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel);
      font-size:var(--fs-sm);
      font-weight:var(--fw-medium);
      cursor:pointer;
      user-select:none;
    }
    .segBtn.on{
      background:var(--orangeTint);
      border-color:rgba(255,153,0,.55);
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr 420px;
      gap:14px;
      margin-top:14px;
      align-items:start;
    }
    @media (max-width:1200px){
      .grid{grid-template-columns:1fr}
    }

    /* Cards */
    .card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:#fff;
    }
    .cardBody{padding:14px 16px}
    .h2{
      margin:0;
      font-size:var(--fs-lg);
      font-weight:var(--fw-bold);
      letter-spacing:-.1px;
      line-height:1.15;
    }
    .hint{
      margin:8px 0 0 0;
      color:var(--muted);
      font-size:var(--fs-md);
      line-height:1.35;
    }

    /* KPI strip (4 cards) */
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:1200px){
      .kpiRow{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width:700px){
      .kpiRow{grid-template-columns: 1fr}
    }
    .kpi{
      border:1px solid var(--line);
      border-radius:var(--r-md);
      background:#fff;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .kpi::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0;
      width:6px;
      background:var(--orange);
    }
    .kpi.red::before{background:var(--orangeRed)}
    .kpiLabel{
      font-size:var(--fs-sm);
      color:var(--muted);
      font-weight:var(--fw-bold);
    }
    .kpiVal{
      margin-top:6px;
      font-size:18px;
      font-weight:var(--fw-heavy);
      letter-spacing:-.2px;
      line-height:1.1;
    }
    .kpiSub{
      margin-top:4px;
      font-size:var(--fs-sm);
      color:var(--muted);
      line-height:1.3;
    }

    /* Left list (12 kk) */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:12px;
      background:#fff;
      cursor:pointer;
      transition:transform .06s ease;
    }
    .item:hover{transform:translateY(-1px)}
    .itemTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .itemTitle{
      font-size:var(--fs-md);
      font-weight:var(--fw-bold);
      line-height:1.25;
      letter-spacing:-.05px;
    }
    .itemMeta{margin-top:6px;color:var(--muted);font-size:var(--fs-sm);line-height:1.35}
    .tagRow{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    .tag{
      font-size:var(--fs-xs);
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      font-weight:var(--fw-medium);
    }

    /* Score badge (1–5) */
    .score{
      min-width:54px;
      text-align:center;
      border-radius:999px;
      padding:6px 10px;
      font-size:var(--fs-sm);
      font-weight:var(--fw-bold);
      border:1px solid rgba(255,153,0,.45);
      background:var(--orangeTint);
      color:#7a3a00;
    }
    .score.high{
      border-color:rgba(255,102,51,.55);
      background:rgba(255,102,51,.12);
      color:#7a1f00;
    }
    .score.low{
      border-color:var(--line);
      background:#fff;
      color:var(--muted);
    }

    /* Timeline chart (24 kk) */
    .chart{
      display:grid;
      grid-template-columns: 64px 1fr;
      gap:12px;
      align-items:start;
    }
    .chartLabel{
      font-size:var(--fs-sm);
      font-weight:var(--fw-bold);
      color:var(--muted);
      padding-top:6px;
    }
    .bars{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:8px;
      align-items:end;
    }
    .bar{
      height:150px;
      border:1px solid var(--line);
      border-radius:var(--r-md);
      background:#fff;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      cursor:pointer;
      overflow:hidden;
    }
    .barInner{
      height:0%;
      background:rgba(255,153,0,.25);
      border-top:1px solid rgba(255,153,0,.35);
      transition:height .15s ease;
    }
    .bar.high .barInner{background:rgba(255,102,51,.22); border-top-color:rgba(255,102,51,.35)}
    .bar.on{outline:3px solid rgba(255,153,0,.22)}
    .barCap{
      padding:10px 10px 9px 10px;
      border-top:1px solid var(--line);
      background:var(--bg);
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:8px;
    }
    .barQ{font-size:var(--fs-xs);font-weight:var(--fw-bold);color:var(--muted)}
    .barV{font-size:var(--fs-md);font-weight:var(--fw-heavy);letter-spacing:-.15px}

    /* Heatmap tiles (not circles) */
    .heat{
      margin-top:12px;
      display:grid;
      grid-template-columns: 120px repeat(5, 1fr);
      gap:8px;
      align-items:stretch;
    }
    .heat .h{
      font-size:var(--fs-xs);
      font-weight:var(--fw-bold);
      color:var(--muted);
      padding:6px 0;
    }
    .heat .r{
      font-size:var(--fs-sm);
      font-weight:var(--fw-bold);
      color:var(--muted);
      display:flex;
      align-items:center;
    }
    .tile{
      height:44px;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:var(--panel);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:var(--fw-heavy);
      letter-spacing:-.15px;
      cursor:pointer;
      user-select:none;
    }
    .tile.low{background:#fff}
    .tile.mid{background:rgba(255,153,0,.16); border-color:rgba(255,153,0,.35)}
    .tile.high{background:rgba(255,102,51,.16); border-color:rgba(255,102,51,.40)}
    .tile.on{outline:3px solid rgba(255,153,0,.22)}

    /* Drilldown */
    .drill{
      margin-top:12px;
      border-top:1px solid var(--line);
      padding-top:12px;
    }
    .drillTitle{
      font-size:var(--fs-md);
      font-weight:var(--fw-bold);
      letter-spacing:-.05px;
    }
    .drillList{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .drillItem{
      font-size:var(--fs-sm);
      line-height:1.3;
    }
    .drillItem small{color:var(--muted);font-weight:var(--fw-regular)}

    a{color:inherit;text-decoration:none}
    a:hover{text-decoration:underline}

    .loading{
      border:1px solid var(--line);
      border-radius:var(--r-md);
      background:var(--panel);
      padding:12px;
      color:var(--muted);
      font-size:var(--fs-md);
    }

    .footer{
      margin-top:22px;
      padding-top:16px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:var(--fs-sm);
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brandRow">
      <a class="logo" href="./yleiskuva.html" aria-label="Owal Group">
        <img src="./assets/owal_logo.png" alt="Owal Group logo" />
      </a>
      <div class="head">
        <div class="pageTitle">Uudistuskuorman seuranta</div>
        <div class="pageSub">Selkeä yleiskuva (12 kk + 24 kk + kartta nyt). Tarkennukset uudistusnäkymässä.</div>
      </div>
    </div>

    <div class="nav">
      <a class="pill on" href="./yleiskuva.html">Yleiskuva</a>
      <a class="pill" href="./index.html?id=pkg-001">Uudistusnäkymä</a>
      <a class="pill" href="./hallinnonalat.html">Hallinnonalat</a>
    </div>
  </div>

  <div class="wrap">
    <div class="filters">
      <div class="search">
        <span class="searchLabel">Hae</span>
        <input id="q" placeholder="esim. työllisyys, data, sote…" />
      </div>

      <select id="sector" class="select" title="Sektori">
        <option value="">Sektori: Kaikki</option>
        <option value="SOTE">SOTE</option>
        <option value="Koulutus">Koulutus</option>
        <option value="Työllisyys">Työllisyys</option>
        <option value="Ilmasto">Ilmasto</option>
        <option value="Digitalisaatio">Digitalisaatio</option>
      </select>

      <div class="seg" aria-label="Kohdistus">
        <span class="segBtn on" data-scope="">Kaikki</span>
        <span class="segBtn" data-scope="Kunnat">Kunnat</span>
        <span class="segBtn" data-scope="Hyvinvointialueet">Hyvinvointialueet</span>
        <span class="segBtn" data-scope="Valtio">Valtio</span>
      </div>
    </div>

    <!-- KPI Row (mockup style) -->
    <div class="kpiRow">
      <div class="kpi">
        <div class="kpiLabel">Uudistusintensiteetti</div>
        <div class="kpiVal" id="kpi-intensity">—</div>
        <div class="kpiSub" id="kpi-intensity-sub">—</div>
      </div>
      <div class="kpi red">
        <div class="kpiLabel">Kapasiteettipaine</div>
        <div class="kpiVal" id="kpi-capacity">—</div>
        <div class="kpiSub" id="kpi-capacity-sub">—</div>
      </div>
      <div class="kpi red">
        <div class="kpiLabel">Aikapaine</div>
        <div class="kpiVal" id="kpi-time">—</div>
        <div class="kpiSub" id="kpi-time-sub">—</div>
      </div>
      <div class="kpi">
        <div class="kpiLabel">Rakenteellinen valmius</div>
        <div class="kpiVal" id="kpi-ready">—</div>
        <div class="kpiSub" id="kpi-ready-sub">—</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: 12 kk list -->
      <div class="card">
        <div class="cardHeader">
          <div class="h2">Uudistukset (12 kk)</div>
          <div class="hint">Klikkaa korttia → avaa uudistusnäkymä.</div>
        </div>
        <div class="cardBody">
          <div id="list" class="loading">Ladataan…</div>
        </div>
      </div>

      <!-- Middle: 24 kk timeline chart -->
      <div class="card">
        <div class="cardHeader">
          <div class="h2">Toimeenpanokuorman aikajana (24 kk)</div>
          <div class="hint">Kvartaaleittain: samanaikaisuus kunnille ja hyvinvointialueille (1–5).</div>
        </div>
        <div class="cardBody">
          <div id="timeline" class="loading">Ladataan…</div>
        </div>
      </div>

      <!-- Right: heatmap now -->
      <div class="card">
        <div class="cardHeader">
          <div class="h2">Kuormituskartta (nyt)</div>
          <div class="hint" id="nowLabel">—</div>
        </div>
        <div class="cardBody">
          <div id="heat" class="loading">Ladataan…</div>

          <div class="drill">
            <div class="drillTitle" id="drillTitle">Valitse solu kartasta</div>
            <div class="drillList" id="drillList"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Owal Group • päätöksenteon ja toimeenpanon tuki</div>
      <div>Lisää paketit: muokkaa <b>PACKAGES</b>-listaa tiedoston lopussa.</div>
    </div>
  </div>

  <script>
    // MVP: listaa paketit manuaalisesti
    const PACKAGES = ["pkg-001", "pkg-002"];
    const DATA_DIR = "./data/";
    const SECTORS = ["SOTE","Koulutus","Työllisyys","Ilmasto","Digitalisaatio"];
    const ROWS = [
      ["Hallinnonalat","Valtio"],
      ["Kunnat","Kunnat"],
      ["Hyvinvointialueet","Hyvinvointialueet"]
    ];

    const $ = (id)=>document.getElementById(id);

    function uniq(arr){ return [...new Set((arr||[]).filter(Boolean))]; }
    function isIsoDate(s){ return typeof s==="string" && /^\\d{4}-\\d{2}-\\d{2}$/.test(s); }
    function addMonths(d, m){ const x=new Date(d.getTime()); x.setMonth(x.getMonth()+m); return x; }

    function quarterLabel(dateStr){
      if(!isIsoDate(dateStr)) return null;
      const [y,m]=dateStr.split("-").map(n=>parseInt(n,10));
      const q=Math.floor((m-1)/3)+1;
      return `${y} Q${q}`;
    }
    function nextQuarters(n=8){
      const out=[];
      const d=new Date();
      const startMonth=Math.floor(d.getMonth()/3)*3;
      const start=new Date(d.getFullYear(), startMonth, 1);
      for(let i=0;i<n;i++){
        const dt=addMonths(start, i*3);
        const y=dt.getFullYear();
        const q=Math.floor(dt.getMonth()/3)+1;
        out.push(`${y} Q${q}`);
      }
      return out;
    }

    function primaryDate(p){
      const ds=(p.events||[]).map(e=>e.date).filter(isIsoDate).sort();
      return ds[0] || null;
    }
    function inNextMonths(dateStr, months){
      if(!isIsoDate(dateStr)) return false;
      const d=new Date(dateStr+"T00:00:00");
      const now=new Date();
      const lim=addMonths(now, months);
      return d>=now && d<=lim;
    }

    // --------- NEW: absolute index (does not collapse on small data) ----------
    function concurrencyIndex(pkg, scope, quarter){
      // +15 per package if it has any event in the quarter
      const qset = new Set((pkg.events||[]).map(e=>quarterLabel(e.date)).filter(Boolean));
      if(!qset.has(quarter)) return 0;

      let idx = 15;

      // themes: +8 kuormittava, +4 sekavaikutus, -3 keventävä
      const themes=(pkg.themes||[]).filter(t => (t.scope||[]).includes(scope));
      for(const t of themes){
        const d=(t.direction||"").toLowerCase();
        if(d.includes("kuormittava")) idx += 8;
        else if(d.includes("sekavaikutus")) idx += 4;
        else if(d.includes("keventävä")) idx -= 3;
      }

      // decree refinements add: +10 if any (scope match loosely)
      const refs=(pkg.decree_refinements||[]);
      if(refs.length) idx += 10;

      return Math.max(0, idx);
    }

    function indexToScore(idx){
      // 1..5 stable buckets
      if(idx >= 75) return 5;
      if(idx >= 55) return 4;
      if(idx >= 35) return 3;
      if(idx >= 20) return 2;
      return 1;
    }
    function scoreClass(v){
      if(v>=4) return "high";
      if(v>=3) return "mid";
      return "low";
    }

    // List score per pkg (12 kk): choose best relevant scope
    function pkgScore12m(pkg, scopeFilter){
      const scopes = scopeFilter ? [scopeFilter] : (pkg.admin_tags?.kohdistus||["Kunnat"]);
      const dates = (pkg.events||[]).map(e=>e.date).filter(isIsoDate);
      const relevant = dates.filter(d=>inNextMonths(d,12));
      if(!relevant.length) return 1;

      // take earliest quarter within 12m and compute score for that quarter
      const q = quarterLabel(relevant.sort()[0]);
      let best=1;
      for(const s of scopes){
        const sc=indexToScore(concurrencyIndex(pkg, s, q));
        best=Math.max(best, sc);
      }
      return best;
    }

    // --------- Filters ----------
    let allPkgs=[];
    let selectedScope="";
    let selectedSector="";
    let qText="";

    function matchesFilters(p){
      const text=(qText||"").toLowerCase().trim();
      const title=(p.title||"").toLowerCase();
      const desc=(p.description||"").toLowerCase();
      const sectors=(p.admin_tags?.sektorit||[]);
      const scopes=(p.admin_tags?.kohdistus||[]);
      if(text && !(title.includes(text) || desc.includes(text))) return false;
      if(selectedSector && !sectors.includes(selectedSector)) return false;
      if(selectedScope && !scopes.includes(selectedScope)) return false;
      return true;
    }

    // --------- Render: KPI row ----------
    function renderKpis(){
      // Use 24kk max score (kunnat/hva) as base summary
      const qs=nextQuarters(8);
      let maxScore=1;
      let maxCount=0;
      let peakQ=null;

      for(const q of qs){
        let sum = 0;
        let count=0;
        for(const p of allPkgs){
          if(!matchesFilters(p)) continue;
          // count if any target in kunnat/hva
          const targets = p.admin_tags?.kohdistus||[];
          const relevantScopes = targets.filter(x => x==="Kunnat" || x==="Hyvinvointialueet");
          for(const s of relevantScopes){
            const idx = concurrencyIndex(p, s, q);
            if(idx>0){ sum += idx; count++; }
          }
        }
        const score=indexToScore(sum);
        if(score>maxScore){ maxScore=score; peakQ=q; maxCount=count; }
      }

      const intensityLabel = maxScore>=4 ? "Keskitaso–korkea" : (maxScore===3 ? "Keskitaso" : "Matala");
      $("kpi-intensity").textContent = intensityLabel;
      $("kpi-intensity-sub").textContent = peakQ ? `Samanaikaisuuspiikki: ${peakQ}` : "Ei ajoittuneita eventtejä";

      // Capacity: based on how many packages match filters in 12 months
      const next12 = allPkgs.filter(p => matchesFilters(p) && (p.events||[]).some(e=>inNextMonths(e.date,12)));
      const cap = next12.length >= 6 ? "Korkea" : (next12.length>=3 ? "Keskitaso" : "Matala");
      $("kpi-capacity").textContent = cap;
      $("kpi-capacity-sub").textContent = `Uudistuksia 12 kk: ${next12.length}`;

      // Time pressure: if many events in next 6 months
      const next6 = allPkgs.filter(p => matchesFilters(p) && (p.events||[]).some(e=>inNextMonths(e.date,6)));
      const time = next6.length >= 4 ? "Tiukka aikataulu" : (next6.length>=2 ? "Kohtalainen" : "Hallittava");
      $("kpi-time").textContent = time;
      $("kpi-time-sub").textContent = `Lähikuukausille osuu: ${next6.length}`;

      // Readiness (proxy): more “roles/data” themes -> lower readiness. Keep neutral.
      let risk=0;
      for(const p of allPkgs){
        if(!matchesFilters(p)) continue;
        for(const t of (p.themes||[])){
          const a=(t.area||"").toLowerCase();
          if(a.includes("data") || a.includes("raport")) risk++;
        }
      }
      const ready = risk>=8 ? "Keskitaso" : (risk>=4 ? "Keskitaso–hyvä" : "Hyvä");
      $("kpi-ready").textContent = ready;
      $("kpi-ready-sub").textContent = "Roolit ja tiedonhallinta korostuvat";
    }

    // --------- Render: list (12 kk) ----------
    function renderList(){
      const items = allPkgs
        .filter(matchesFilters)
        .map(p=>{
          const d = primaryDate(p);
          const dateLabel = d ? `Seuraava virstanpylväs: ${d}` : "Ajankohta: —";
          const scopeForScore = selectedScope || (p.admin_tags?.kohdistus||[])[0] || "Kunnat";
          const score = pkgScore12m(p, scopeForScore);
          const cls = score>=4 ? "high" : (score<=2 ? "low" : "");
          const tags = []
            .concat((p.admin_tags?.sektorit||[]).slice(0,2).map(x=>`<span class="tag">${x}</span>`))
            .concat((p.admin_tags?.kohdistus||[]).slice(0,2).map(x=>`<span class="tag">${x}</span>`))
            .join("");

          return `
            <div class="item" onclick="location.href='./index.html?id=${p.package_id}'">
              <div class="itemTop">
                <div>
                  <div class="itemTitle">${p.title || p.package_id}</div>
                  <div class="itemMeta">${dateLabel}</div>
                </div>
                <div class="score ${cls}">${score}/5</div>
              </div>
              <div class="tagRow">${tags}</div>
            </div>
          `;
        });

      $("list").className="";
      $("list").innerHTML = `<div class="list">${items.length ? items.join("") : `<div class="loading">Ei osumia suodattimilla.</div>`}</div>`;
    }

    // --------- Render: timeline (24 kk) ----------
    function renderTimeline(){
      const qs=nextQuarters(8);
      // compute sum index for each quarter (kunnat + hva)
      const vals = qs.map(q=>{
        let sumIdx=0;
        for(const p of allPkgs){
          if(!matchesFilters(p)) continue;
          // sector filter already in matchesFilters
          const targets = p.admin_tags?.kohdistus||[];
          if(targets.includes("Kunnat")) sumIdx += concurrencyIndex(p, "Kunnat", q);
          if(targets.includes("Hyvinvointialueet")) sumIdx += concurrencyIndex(p, "Hyvinvointialueet", q);
        }
        return sumIdx;
      });

      const max = Math.max(1, ...vals);
      const bars = qs.map((q, i)=>{
        const idx = vals[i];
        const score = indexToScore(idx);
        const cls = scoreClass(score);
        const pct = Math.round((idx / max) * 100);
        return `
          <div class="bar ${cls}" data-q="${q}" data-idx="${idx}" data-score="${score}">
            <div class="barInner" style="height:${pct}%"></div>
            <div class="barCap">
              <div class="barQ">${q}</div>
              <div class="barV">${score}/5</div>
            </div>
          </div>
        `;
      }).join("");

      $("timeline").className="";
      $("timeline").innerHTML = `
        <div class="chart">
          <div class="chartLabel">Kunnat + HVA</div>
          <div class="bars" id="bars">${bars}</div>
        </div>
      `;

      // click selects quarter and re-renders heat "now label" to that quarter
      document.querySelectorAll(".bar").forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll(".bar").forEach(x=>x.classList.remove("on"));
          el.classList.add("on");
          const q = el.getAttribute("data-q");
          $("nowLabel").textContent = `Valittu ajankohta: ${q} (kartta näyttää lähikuukausien painotuksen)`;
        });
      });
    }

    // --------- Render: heatmap (now = next 6 months) ----------
    function renderHeatmap(){
      // compute max score per row x sector among pkgs with event in next 6 months
      const now = new Date();
      const inNow = (pkg) => {
        const dates=(pkg.events||[]).map(e=>e.date).filter(isIsoDate);
        return dates.some(d=>inNextMonths(d,6));
      };

      const cellScore={}; // rowName -> sector -> score
      const cellPkgs={};  // rowName -> sector -> pkgs
      for(const [rowName] of ROWS){
        cellScore[rowName]={}; cellPkgs[rowName]={};
        for(const sec of SECTORS){
          cellScore[rowName][sec]=1;
          cellPkgs[rowName][sec]=[];
        }
      }

      for(const p of allPkgs){
        if(!matchesFilters(p)) continue;
        if(!inNow(p)) continue;

        const pSectors=p.admin_tags?.sektorit||[];
        for(const sec of SECTORS){
          if(!pSectors.includes(sec)) continue;
          for(const [rowName, scopeKey] of ROWS){
            if(!(p.admin_tags?.kohdistus||[]).includes(scopeKey)) continue;
            const sc = pkgScore12m(p, scopeKey); // stable 1..5
            cellScore[rowName][sec] = Math.max(cellScore[rowName][sec], sc);
            cellPkgs[rowName][sec].push(p);
          }
        }
      }

      $("nowLabel").textContent = `Nyt (lähikuukaudet): kuormituskartta sektorin ja kohdistuksen mukaan`;

      let html = `<div class="heat">`;
      html += `<div></div>`;
      for(const sec of SECTORS) html += `<div class="h">${sec}</div>`;
      for(const [rowName] of ROWS){
        html += `<div class="r">${rowName}</div>`;
        for(const sec of SECTORS){
          const v = cellScore[rowName][sec];
          const cls = scoreClass(v);
          html += `<div class="tile ${cls}" data-row="${rowName}" data-sec="${sec}">${v}/5</div>`;
        }
      }
      html += `</div>`;
      $("heat").className="";
      $("heat").innerHTML=html;

      // drill
      document.querySelectorAll(".tile").forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll(".tile").forEach(x=>x.classList.remove("on"));
          el.classList.add("on");
          const row = el.getAttribute("data-row");
          const sec = el.getAttribute("data-sec");
          const pkgs = (cellPkgs[row][sec]||[])
            .filter(matchesFilters)
            .slice(0,10);

          $("drillTitle").textContent = `${row} • ${sec}`;
          $("drillList").innerHTML = pkgs.length
            ? pkgs.map(p=>`<div class="drillItem"><a href="./index.html?id=${p.package_id}"><b>${p.title}</b></a> <small>(${p.package_id})</small></div>`).join("")
            : `<div class="loading">Ei osumia lähikuukausille tässä sektorissa.</div>`;
        });
      });
    }

    // --------- Wiring ----------
    async function loadAll(){
      const pkgs=[];
      for(const id of PACKAGES){
        try{
          const r=await fetch(`${DATA_DIR}${id}.json`, {cache:"no-cache"});
          if(!r.ok) continue;
          pkgs.push(await r.json());
        }catch(e){}
      }
      allPkgs=pkgs;

      renderKpis();
      renderList();
      renderTimeline();
      renderHeatmap();
    }

    function wire(){
      $("q").addEventListener("input", (e)=>{
        qText=e.target.value;
        renderKpis(); renderList(); renderTimeline(); renderHeatmap();
      });

      $("sector").addEventListener("change", (e)=>{
        selectedSector=e.target.value;
        renderKpis(); renderList(); renderTimeline(); renderHeatmap();
      });

      document.querySelectorAll("[data-scope]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll("[data-scope]").forEach(x=>x.classList.remove("on"));
          btn.classList.add("on");
          selectedScope=btn.getAttribute("data-scope");
          renderKpis(); renderList(); renderTimeline(); renderHeatmap();
        });
      });
    }

    wire();
    loadAll();
  </script>
</body>
</html>
