<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toimeenpanotilannekuva – Uudistusnäkymä</title>
  <meta name="description" content="Säädöspaketti = laki + asetukset. Kenttävaikutus ja kasautumat päätöksenteon ja toimeenpanon tueksi." />

  <style>
    :root{
      /* Brand */
      --owal-orange:#FF9900;
      --owal-purple:#6600CC;
      --orangeL:#FFF2E8;
      --purpleL:#F2EBFF;

      /* Neutrals */
      --text:#1A1A1A;
      --muted:#666666;
      --line:#E6E6E6;
      --panel:#F8F8F8;
      --panel2:#F4F4F4;
      --white:#FFFFFF;

      /* UI */
      --radius:18px;
      --shadow:0 1px 0 rgba(0,0,0,.03);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Mark FF","MarkFF","Mark FF Pro",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--white);
    }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:20;
      background:var(--white);
      border-bottom:2px solid var(--line);
      padding:16px 22px 12px 22px;
    }
    .topbar::after{
      content:"";
      display:block;
      height:4px;
      background:var(--owal-orange);
      margin:12px -22px -12px -22px;
    }
    .brandRow{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;text-decoration:none}
    .logo img{height:34px;width:auto;display:block}
    .titleWrap{min-width:260px;flex:1}
    h1{margin:0;font-size:22px;font-weight:900;letter-spacing:.1px}
    .subtitle{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    .nav{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--panel2);
      font-size:12px;
      text-decoration:none;
      color:var(--text);
      cursor:pointer;
      user-select:none;
    }
    .pill.on{background:var(--orangeL);border-color:var(--owal-orange)}
    .pill.purple{background:var(--purpleL);border-color:var(--owal-purple)}
    .pill.ghost{background:#fff}

    .wrap{max-width:1220px;margin:0 auto;padding:20px 22px 70px 22px}

    /* Cards */
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{
      background:var(--white);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .accent{width:10px;background:var(--owal-orange);border-radius:var(--radius) 0 0 var(--radius);flex:0 0 auto}
    .body{padding:14px 16px}
    .kpi{flex:1;min-width:240px;display:flex}
    .label{color:var(--muted);font-size:12px}
    .val{font-weight:900;font-size:18px;margin-top:6px}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}

    /* Layout */
    .mainGrid{display:grid;grid-template-columns:1.45fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.mainGrid{grid-template-columns:1fr}}

    h2{margin:0 0 10px 0;font-size:16px;font-weight:900}
    .hint{margin:0 0 12px 0;color:var(--muted);font-size:13px;line-height:1.35}

    /* Inner tabs */
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--panel2);font-size:12px;cursor:pointer}
    .tab.on{background:var(--orangeL);border-color:var(--owal-orange)}

    /* Tables */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
    }
    thead th{
      text-align:left;
      font-size:12px;
      background:#EEE;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody td{
      font-size:13px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none}

    .badge{
      display:inline-flex;align-items:center;
      padding:4px 9px;border-radius:12px;
      font-size:11px;border:1px solid var(--line);
      background:#EEE;color:var(--muted);
      white-space:nowrap;
    }
    .badge.orange{background:var(--orangeL);border-color:var(--owal-orange);color:var(--owal-orange)}
    .badge.purple{background:var(--purpleL);border-color:var(--owal-purple);color:var(--owal-purple)}
    .small{font-size:12px;color:var(--muted)}
    a{color:var(--text);text-decoration:none}
    a:hover{text-decoration:underline}

    .note{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .loading{
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--panel);
      padding:12px;
      color:var(--muted);
      font-size:13px;
    }
    .error{
      border:1px solid #ffb4b4;
      border-radius:14px;
      background:#fff0f0;
      padding:12px;
      color:#7a1a1a;
      font-size:13px;
    }

    .footer{
      margin-top:22px;padding-top:16px;border-top:1px solid var(--line);
      color:var(--muted);font-size:12px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brandRow">
      <a class="logo" href="./yleiskuva.html" aria-label="Owal Group">
        <img src="./assets/owal_logo.png" alt="Owal Group logo" />
      </a>
      <div class="titleWrap">
        <h1>Toimeenpanotilannekuva</h1>
        <div class="subtitle">Uudistusnäkymä: säädöspaketti (laki + asetukset) • kenttävaikutus ja kasautumat (abstrakti)</div>
      </div>
    </div>

    <div class="nav">
      <a class="pill" href="./yleiskuva.html">Yleiskuva</a>
      <a class="pill on" href="./index.html">Uudistusnäkymä</a>
      <a class="pill" href="./hallinnonalat.html">Hallinnonalat</a>
      <span class="pill purple" id="pkg-chip">Paketti: pkg-001</span>
      <span class="pill ghost small">Vaihto: <span class="mono">?id=pkg-001</span></span>
    </div>
  </div>

  <div class="wrap">
    <!-- KPI row: 3 cards like mockups -->
    <div class="row">
      <div class="card kpi">
        <div class="accent"></div>
        <div class="body">
          <div class="label">Hallinnonalat</div>
          <div class="val" id="kpi-state">—</div>
          <div class="sub" id="kpi-state-sub">—</div>
        </div>
      </div>

      <div class="card kpi">
        <div class="accent"></div>
        <div class="body">
          <div class="label">Kunnat</div>
          <div class="val" id="kpi-muni">—</div>
          <div class="sub" id="kpi-muni-sub">—</div>
        </div>
      </div>

      <div class="card kpi">
        <div class="accent"></div>
        <div class="body">
          <div class="label">Hyvinvointialueet</div>
          <div class="val" id="kpi-hva">—</div>
          <div class="sub" id="kpi-hva-sub">—</div>
        </div>
      </div>
    </div>

    <!-- Main grid: left big + right sidebar -->
    <div class="mainGrid">

      <!-- LEFT: context panel with tabs -->
      <div class="card">
        <div class="body">
          <h2 id="panel-title">Kunnan toimeenpanokuva</h2>
          <p class="hint" id="panel-hint">
            Abstrakti näkymä: mitä teemoja säädöspaketti tuo ja mihin vaikutusalueisiin se osuu. Teemat ovat ankkuroituja lähteisiin.
          </p>

          <!-- Toggle: Kunta / HVA / Hallinnonalat -->
          <div class="tabs" aria-label="Tarkastelukulma">
            <span class="tab on" data-view="Kunnat">Kunta</span>
            <span class="tab" data-view="Hyvinvointialueet">Hyvinvointialue</span>
            <span class="tab" data-view="Valtio">Hallinnonalat</span>
          </div>

          <!-- Inner tabs: Aikajana / Teemat / Päällekkäisyydet -->
          <div class="tabs" aria-label="Sisällys">
            <span class="tab on" data-tab="timeline">Aikajana</span>
            <span class="tab" data-tab="themes">Toimeenpanoteemat</span>
            <span class="tab" data-tab="overlaps">Päällekkäisyydet</span>
          </div>

          <div id="tab-timeline" class="loading">Ladataan aikajanaa…</div>
          <div id="tab-themes" class="loading" style="display:none">Ladataan teemoja…</div>
          <div id="tab-overlaps" class="loading" style="display:none">Lasketaan päällekkäisyyksiä…</div>
        </div>
      </div>

      <!-- RIGHT: sidebar cards -->
      <div>
        <div class="card">
          <div class="body">
            <h2>Säädöspaketti</h2>
            <p class="hint">Laki + asetukset muodostavat kokonaisuuden. Linkit lähteisiin.</p>
            <div id="docs-wrap" class="loading">Ladataan lähteitä…</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="body">
            <h2>Täsmennyskohdat asetuksilla</h2>
            <p class="hint">Mitä asioita asetuksissa täsmennetään (osa suunniteltua kokonaisuutta).</p>
            <div id="ref-wrap" class="loading">Ladataan täsmennyksiä…</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="body">
            <h2>Sektorivaikutus</h2>
            <p class="hint">Sektorit ja ajurit teemojen perusteella (abstrakti).</p>
            <div id="sector-wrap" class="loading">Lasketaan…</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Bottom sources -->
    <div style="height:14px"></div>
    <div class="card">
      <div class="body">
        <h2>Lähteet ja perustelut</h2>
        <p class="hint">Näytetään ankkurit (lähde + kohta + katkelma) läpinäkyvyyden varmistamiseksi.</p>
        <div id="sources-wrap" class="loading">Ladataan ankkureita…</div>
      </div>
    </div>

    <div class="footer">
      <div>Owal Group • yhteiskunnallisen vaikuttavuuden asiantuntijayritys • Tieto päätöksenteon tueksi</div>
      <div class="mono">data: <span id="data-path">./data/pkg-001.json</span></div>
    </div>
  </div>

  <script>
    // ---------------- Config ----------------
    const DEFAULT_ID = "pkg-001";
    const DATA_DIR = "./data/";

    // ---------------- Helpers ----------------
    const $ = (id) => document.getElementById(id);

    function getQueryParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function uniq(arr){ return [...new Set((arr||[]).filter(Boolean))]; }

    function isIsoDate(s){ return typeof s === "string" && /^\\d{4}-\\d{2}-\\d{2}$/.test(s); }

    function fmtDate(s){
      if(!isIsoDate(s)) return s;
      const [y,m,d] = s.split("-").map(x=>parseInt(x,10));
      return `${d}.${m}.${y}`;
    }

    function quarterLabel(dateStr){
      if(!isIsoDate(dateStr)) return "—";
      const [y,m] = dateStr.split("-").map(n=>parseInt(n,10));
      const q = Math.floor((m-1)/3)+1;
      return `${y} Q${q}`;
    }

    function sortEventsByDate(events){
      return [...(events||[])].sort((a,b)=>{
        const da = isIsoDate(a.date) ? a.date : "9999-99-99";
        const db = isIsoDate(b.date) ? b.date : "9999-99-99";
        return da.localeCompare(db);
      });
    }

    function buildTable(headers, rowsHtml){
      return `
        <table>
          <thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function safe(s){ return (s ?? "").toString(); }

    function scoreLabel(themes, scopeName){
      // Abstrakti: kuormittava=2, sekavaikutus=1, keventävä=-1
      const scoped = (themes||[]).filter(t => (t.scope||[]).includes(scopeName));
      let score = 0;
      scoped.forEach(t=>{
        const d = (t.direction||"").toLowerCase();
        if(d.includes("kuormittava")) score += 2;
        else if(d.includes("sekavaikutus")) score += 1;
        else if(d.includes("keventävä")) score -= 1;
      });
      if(score >= 4) return "Korkea";
      if(score >= 2) return "Keskitaso";
      return "Matala";
    }

    // ---------------- Renderers ----------------
    function renderDocs(pkg){
      const docs = pkg.documents || [];
      const rows = docs.map(d=>{
        const badgeClass = d.type==="VNA" ? "orange" : (d.type==="MIN" ? "purple" : "");
        const badgeText = d.type || "Dokumentti";
        const link = d.url ? `<a href="${d.url}" target="_blank" rel="noreferrer">${safe(d.title)}</a>` : safe(d.title);
        const date = d.date ? ` • ${fmtDate(d.date)}` : "";
        return `<div style="margin:10px 0">
          <span class="badge ${badgeClass}">${badgeText}</span>
          ${link}
          <span class="small">${date}</span>
        </div>`;
      }).join("");

      $("docs-wrap").className = "";
      $("docs-wrap").innerHTML = rows || `<div class="note">Ei dokumentteja.</div>`;
    }

    function renderTimeline(pkg, viewScope){
      const events = sortEventsByDate(pkg.events || []);
      const rows = events.map(ev=>{
        const scope = (ev.scope || []).join(", ");
        const anchor = ev.anchor
          ? `<span class="badge">${safe(ev.anchor.doc_type||"—")}</span> ${safe(ev.anchor.ref||"—")}<div class="small">${safe(ev.anchor.quote||"")}</div>`
          : "—";
        return `<tr>
          <td>${safe(ev.type)}</td>
          <td>${fmtDate(safe(ev.date))}</td>
          <td>${scope || "—"}</td>
          <td>${anchor}</td>
        </tr>`;
      }).join("");

      $("tab-timeline").className = "";
      $("tab-timeline").innerHTML = buildTable(
        ["Tyyppi","Päivä / ajankohta","Kohdistus","Ankkuri"],
        rows || `<tr><td colspan="4">Ei virstanpylväitä.</td></tr>`
      );
    }

    function renderThemes(pkg, viewScope){
      // Suodatetaan scopeen: näytetään teemat, joissa scope listassa valittu
      const themes = (pkg.themes || []).filter(t => (t.scope||[]).includes(viewScope) || viewScope==="Valtio");
      const rows = themes.map(th=>{
        const src = th.anchor ? `${safe(th.anchor.doc_type)} ${safe(th.anchor.ref)}` : "—";
        const quote = th.anchor?.quote ? `<div class="small">${safe(th.anchor.quote)}</div>` : "";
        return `<tr>
          <td>${safe(th.text)}${quote}</td>
          <td>${safe(th.area)}</td>
          <td>${safe(th.anchor?.doc_type || "—")}</td>
          <td>${safe(th.anchor?.ref || "—")}</td>
        </tr>`;
      }).join("");

      $("tab-themes").className = "";
      $("tab-themes").innerHTML = buildTable(
        ["Teema","Vaikutusalue","Lähde","Kohta"],
        rows || `<tr><td colspan="4">Ei teemoja valitulle näkökulmalle.</td></tr>`
      );
    }

    function renderRefinements(pkg){
      const refs = pkg.decree_refinements || [];
      const rows = refs.map(r=>{
        const badgeClass = r.decree==="VNA" ? "orange" : (r.decree==="MIN" ? "purple" : "");
        const scope = (r.scope || []).join(", ");
        const anch = r.anchor?.quote ? `<div class="small">${safe(r.anchor.quote)}</div>` : "";
        return `<tr>
          <td><span class="badge ${badgeClass}">${safe(r.decree)}</span></td>
          <td>${safe(r.what)}${anch}</td>
          <td>${safe(r.area)}</td>
          <td>${safe(scope)}</td>
        </tr>`;
      }).join("");

      $("ref-wrap").className = "";
      $("ref-wrap").innerHTML = buildTable(
        ["Asetus","Täsmennys","Vaikutusalue","Kohdistus"],
        rows || `<tr><td colspan="4">Ei täsmennyksiä.</td></tr>`
      );
    }

    function renderSectors(pkg){
      const sectors = uniq(pkg.admin_tags?.sektorit || []);
      const areas = uniq((pkg.themes||[]).map(t=>t.area)).slice(0,8);
      const sectorChips = sectors.map(s=>`<span class="badge orange" style="margin-right:6px;margin-bottom:6px">${s}</span>`).join("");
      const areaChips = areas.map(a=>`<span class="badge" style="margin-right:6px;margin-bottom:6px">${a}</span>`).join("");

      $("sector-wrap").className = "";
      $("sector-wrap").innerHTML = `
        <div class="note">
          <div style="margin-bottom:8px"><b>Sektorit</b></div>
          <div>${sectorChips || "<span class='small'>Ei sektoreita.</span>"}</div>
          <div style="margin:12px 0 8px 0"><b>Ajurit (vaikutusalueet)</b></div>
          <div>${areaChips || "<span class='small'>Ei teemoja.</span>"}</div>
        </div>
      `;
    }

    function renderOverlaps(pkg, viewScope){
      // MVP: päällekkäisyys = samassa kvartaaleissa useita eventtejä + teemoja data-IT/raportointi
      const events = (pkg.events || []).filter(e => isIsoDate(e.date));
      const byQ = {};
      events.forEach(ev=>{
        const q = quarterLabel(ev.date);
        byQ[q] = byQ[q] || [];
        byQ[q].push(ev);
      });

      const themes = (pkg.themes || []).filter(t => (t.scope||[]).includes(viewScope) || viewScope==="Valtio");
      const driverCount = (area) => themes.filter(t => (t.area||"") === area).length;

      const qs = Object.keys(byQ).sort();
      const rows = qs.map(q=>{
        const evs = byQ[q] || [];
        const drivers = [
          ["Data-IT", driverCount("Data-IT")],
          ["Raportointi", driverCount("Raportointi")],
          ["Prosessi", driverCount("Prosessi")],
          ["Ohjeistus", driverCount("Ohjeistus")],
          ["Yhteistyö", driverCount("Yhteistyö")],
          ["Rahoitus", driverCount("Rahoitus")]
        ].filter(x=>x[1]>0).slice(0,3);

        const driverChips = drivers.map(d=>`<span class="badge orange" style="margin-right:6px">${d[0]} (${d[1]})</span>`).join("");
        const evList = evs.slice(0,4).map(e=>`${fmtDate(e.date)} • ${e.type}`).join("<br/>");

        return `<tr>
          <td>${q}</td>
          <td>${evs.length}</td>
          <td>${driverChips || "—"}</td>
          <td class="small">${evList || "—"}</td>
        </tr>`;
      }).join("");

      $("tab-overlaps").className = "";
      $("tab-overlaps").innerHTML = buildTable(
        ["Ajankohta (kvartaali)","Eventtejä","Ajurit (top)","Esimerkkejä"],
        rows || `<tr><td colspan="4">Ei ajallisia päällekkäisyyksiä datassa (tai päivämäärät puuttuvat).</td></tr>`
      );
    }

    function renderSources(pkg){
      // Kootaan ankkurit: eventit + teemat + refinements, dedupe (doc_type + ref + quote)
      const list = [];
      (pkg.events || []).forEach(e=>{
        if(e.anchor && (e.anchor.ref || e.anchor.quote)){
          list.push({doc:e.anchor.doc_type, ref:e.anchor.ref, quote:e.anchor.quote});
        }
      });
      (pkg.themes || []).forEach(t=>{
        if(t.anchor && (t.anchor.ref || t.anchor.quote)){
          list.push({doc:t.anchor.doc_type, ref:t.anchor.ref, quote:t.anchor.quote});
        }
      });
      (pkg.decree_refinements || []).forEach(r=>{
        if(r.anchor && (r.anchor.ref || r.anchor.quote)){
          list.push({doc:r.decree, ref:r.anchor.ref, quote:r.anchor.quote});
        }
      });

      const seen = new Set();
      const uniqList = list.filter(x=>{
        const k = `${x.doc}|${x.ref}|${x.quote}`;
        if(seen.has(k)) return false;
        seen.add(k);
        return true;
      }).slice(0,40);

      const rows = uniqList.map(x=>`
        <tr>
          <td><span class="badge">${safe(x.doc||"—")}</span></td>
          <td>${safe(x.ref||"—")}</td>
          <td class="small">${safe(x.quote||"")}</td>
        </tr>
      `).join("");

      $("sources-wrap").className = "";
      $("sources-wrap").innerHTML = buildTable(
        ["Lähde","Kohta","Katkelma"],
        rows || `<tr><td colspan="3">Ei ankkureita.</td></tr>`
      );
    }

    function renderKPIs(pkg){
      // abstraktit tasot per kohdistus
      const themes = pkg.themes || [];

      const state = scoreLabel(themes, "Valtio"); // valtio ei ole yleensä teemojen scopeissa; käytetään kokonaisuuden “ajurit”
      const muni = scoreLabel(themes, "Kunnat");
      const hva = scoreLabel(themes, "Hyvinvointialueet");

      $("kpi-state").textContent = `Kenttävaikutus: ${state}`;
      $("kpi-state-sub").textContent = (pkg.admin_tags?.hallinnonala ? `Hallinnonala: ${pkg.admin_tags.hallinnonala}` : "—");

      $("kpi-muni").textContent = `Kenttävaikutus: ${muni}`;
      $("kpi-muni-sub").textContent = "Ajurit ja täsmennykset (abstrakti)";

      $("kpi-hva").textContent = `Kenttävaikutus: ${hva}`;
      $("kpi-hva-sub").textContent = "Ajurit ja täsmennykset (abstrakti)";
    }

    // ---------------- UI State ----------------
    let currentScope = "Kunnat";
    let currentTab = "timeline";
    let currentPkg = null;

    function setScope(scope){
      currentScope = scope;
      // update headline like mockup
      if(scope === "Kunnat"){
        $("panel-title").textContent = "Kunnan toimeenpanokuva";
        $("panel-hint").textContent = "Abstrakti näkymä: mitä teemoja säädöspaketti tuo ja mihin vaikutusalueisiin se osuu (kunnat).";
      } else if(scope === "Hyvinvointialueet"){
        $("panel-title").textContent = "Hyvinvointialueen toimeenpanokuva";
        $("panel-hint").textContent = "Abstrakti näkymä: mitä teemoja säädöspaketti tuo ja mihin vaikutusalueisiin se osuu (HVA).";
      } else {
        $("panel-title").textContent = "Hallinnonalojen tilannekuva (tämän uudistuksen osalta)";
        $("panel-hint").textContent = "Tarkastelu ohjauksen näkökulmasta: missä ajurit ja täsmennykset voivat kasautua kentälle.";
      }
      rerender();
    }

    function setTab(tab){
      currentTab = tab;
      ["timeline","themes","overlaps"].forEach(t=>{
        $("tab-"+t).style.display = (t===tab) ? "block" : "none";
      });
      rerender();
    }

    function rerender(){
      if(!currentPkg) return;
      if(currentTab === "timeline") renderTimeline(currentPkg, currentScope);
      if(currentTab === "themes") renderThemes(currentPkg, currentScope);
      if(currentTab === "overlaps") renderOverlaps(currentPkg, currentScope);
    }

    function wireTabs(){
      document.querySelectorAll("[data-tab]").forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll("[data-tab]").forEach(x=>x.classList.remove("on"));
          el.classList.add("on");
          setTab(el.getAttribute("data-tab"));
        });
      });

      document.querySelectorAll("[data-view]").forEach(el=>{
        el.addEventListener("click", ()=>{
          document.querySelectorAll("[data-view]").forEach(x=>x.classList.remove("on"));
          el.classList.add("on");
          setScope(el.getAttribute("data-view"));
        });
      });
    }

    // ---------------- Load ----------------
    async function load(){
      wireTabs();

      const id = getQueryParam("id") || DEFAULT_ID;
      $("pkg-chip").textContent = `Paketti: ${id}`;
      const path = `${DATA_DIR}${id}.json`;
      $("data-path").textContent = path;

      try{
        const res = await fetch(path, {cache:"no-cache"});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const pkg = await res.json();
        currentPkg = pkg;

        renderKPIs(pkg);
        renderDocs(pkg);
        renderRefinements(pkg);
        renderSectors(pkg);
        renderSources(pkg);

        // default renders
        setScope("Kunnat");
        setTab("timeline");

      } catch(e){
        const msg = `JSONin lataus epäonnistui: ${e.message}. Varmista että tiedosto löytyy: ${DATA_DIR}${DEFAULT_ID}.json`;
        ["docs-wrap","ref-wrap","sector-wrap","sources-wrap","tab-timeline","tab-themes","tab-overlaps"].forEach(id=>{
          $(id).className = "error";
          $(id).textContent = msg;
        });
      }
    }

    load();
  </script>
</body>
</html>
